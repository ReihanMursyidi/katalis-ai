<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Katalis AI - Asisten Cerdas Para Pengajar</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles/app.css">
    <script src="mapel.js"></script>
    <script src="login.js"></script>

    <style>
        /* --- GLOBAL FIX --- */
        :root { --accent-blue: #3b82f6; --bg-dark: #0f172a; --bg-panel: #1e293b; --border-color: #334155; --text-muted: #94a3b8; }

        /* --- LAYOUT FIX --- */
        .main-container { display: flex; height: 100vh; width: 100vw; }

        /* --- FORM FIX (ANTI MENGECIL) --- */
        .form-row { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 12px !important; width: 100% !important; margin-bottom: 1rem; }
        .form-group.half { width: 100% !important; min-width: 0; margin: 0; }
        .form-group select, .form-group input { width: 100% !important; background: var(--bg-dark); border: 1px solid var(--border-color); padding: 8px; border-radius: 6px; color: white; display: block; box-sizing: border-box; }
        .form-group { margin-bottom: 1rem; }
        .hidden-form { display: none !important; }
        .active-form { display: block !important; animation: fadeIn 0.3s; }
        
        /* --- LOGO FIX --- */
        .logo { color: white !important; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; margin-bottom: 10px; }
        .text-blue { color: var(--accent-blue) !important; }
        
        /* --- PROFILE STATS FIX --- */
        .profile-stats {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .coin-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(251, 191, 36, 0.1);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        .coin-count { font-weight: bold; color: #fbbf24; }
        
        /* --- ANIMASI --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>

</head>
<body>

    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <button class="modal-close" onclick="toggleAuthModal(false)"><i class="fa-solid fa-times"></i></button>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="tab-login" onclick="switchAuthMode('login')">Masuk</div>
                <div class="auth-tab" id="tab-register" onclick="switchAuthMode('register')">Daftar</div>
            </div>

            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login_email" required placeholder="nama@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login_password" required placeholder="********">
                </div>
                <button type="submit" class="btn-submit">Masuk</button>
            </form>

            <form id="form-register" class="hidden" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Nama Lengkap</label>
                    <input type="text" id="reg_name" required placeholder="Pak Budi">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reg_email" required placeholder="nama@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="reg_password" required placeholder="Buat password aman">
                </div>
                <button type="submit" class="btn-submit btn-purple">Daftar Sekarang</button>
            </form>
        </div>
    </div>

    <div class="main-container">
        <aside class="input-panel">
            <header>
                <div class="logo">
                    <a href="index.html">
                        <i class="fa-solid fa-atom text-blue" style="margin-right: 0.5rem;"></i>
                    </a>
                    Katalis<span class="text-blue">AI</span>
                </div>
                <p class="subtitle">Membantu Produktivitas Para Pengajar di Indonesia</p>

                <div class="user-section">
                    <div id="guest-view" class="guest-view" style="padding: 20px;">
                        <div style="width: 50px; height: 50px; background: #334155; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-user-lock text-slate-400"></i>
                        </div>
                        <p style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 15px;">
                            Akses fitur lengkap & simpan progress Anda.
                        </p>
                        <button class="btn-login-nav" onclick="toggleAuthModal(true)">
                            Masuk Akun
                        </button>
                    </div>

                    <div id="user-view" class="user-view">
                        <div class="profile-header">
                            <div class="avatar-circle" id="user-avatar">U</div>
                            
                            <div class="user-info">
                                <span class="user-name" id="display-name">User</span>
                                <span class="user-role">
                                    <i class="fa-solid fa-circle-check text-green-500" style="font-size: 0.6rem;"></i> Basic Plan
                                </span>
                            </div>

                            <button class="btn-logout-icon" onclick="handleLogout()" title="Keluar">
                                <i class="fa-solid fa-power-off"></i>
                            </button>
                        </div>

                        <div class="profile-stats">
                            <span class="coin-label">Sisa Koin Anda</span>
                            <div class="coin-badge">
                                <i class="fa-solid fa-coins text-yellow-500"></i>
                                <span class="coin-count" id="display-coins">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-nav">
                    
                    <button class="tab-btn active" onclick="switchTab('rpp')">
                        <i class="fa-solid fa-book-open"></i> Modul Ajar
                    </button>
                    <button class="tab-btn" onclick="switchTab('quiz')">
                        <i class="fa-solid fa-list-check"></i> Kuis Soal
                    </button>
                    <button class="tab-btn" onclick="switchTab('rapor')" style="position: relative;">
                        <i class="fa-solid fa-pen-nib"></i> Rapor
                    </button>
                </div>
            </header>

            <form id="form-rpp" class="active-form">
                <p class="section-label">Konfigurasi RPP</p>

                <div class="form-row">
                    <div class="form-group half">
                        <label>Jenjang</label>
                        <select id="rpp_jenjang" onchange="updateKelas('rpp')">
                            <option disabled selected>Pilih Jenjang...</option>
                            <option value="SD">SD</option>
                            <option value="SMP">SMP</option>
                            <option value="SMA">SMA</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label>Kelas</label>
                        <select id="rpp_kelas">
                            <option disabled selected>Pilih Kelas</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Mata Pelajaran</label>
                    <select id="rpp_mapel" onchange="checkMapelLainnya('rpp')">
                        <option disabled selected>Pilih Jenjang & Kelas dulu...</option>
                    </select>
                    
                    <input type="text" id="rpp_mapel_manual" class="hidden" placeholder="Tulis nama mata pelajaran..." style="margin-top: 10px;">
                </div>

                <div class="form-group">
                    <label>Kompetensi Inti (KI)</label>
                    <textarea id="rpp_ki" rows="3" placeholder="KI-1: Menghayati dan mengamalkan...&#10;KI-2: ...&#10;KI-3: ...&#10;KI-4: ..."></textarea>
                </div>

                <div class="form-group">
                    <label>Kompetensi Dasar (KD)</label>
                    <textarea id="rpp_kd" rows="3" placeholder="3.1 Memahami konsep...&#10;4.1 Menyajikan hasil..."></textarea>
                </div>

                <div class="form-group">
                    <label>Materi Pokok</label>
                    <input type="text" id="rpp_materi" maxlength="100" placeholder="Cth: Teks Prosedur Kompleks (Maks 100 karakter)">
                    <p style="font-size: 0.7rem; color: #64748b; margin-top: 4px;">*Maksimal 100 karakter</p>
                </div>

                <div class="form-group">
                    <label>Model Pembelajaran</label>
                    <select id="rpp_model">
                        <option value="Problem Based Learning (PBL)">Problem Based Learning (PBL)</option>
                        <option value="Project Based Learning (PjBL)">Project Based Learning (PjBL)</option>
                        <option value="Discovery Learning">Discovery Learning</option>
                        <option value="Inquiry Learning">Inquiry Learning</option>
                        <option value="Cooperative Learning">Cooperative Learning</option>
                        <option value="Contextual Teaching and Learning">Contextual Teaching and Learning (CTL)</option>
                        <option value="Saintifik (5M)">Pendekatan Saintifik (5M)</option>
                        <option value="Diskusi & Tanya Jawab">Diskusi & Tanya Jawab (Konvensional)</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label>Jumlah JP</label>
                        <input type="number" id="rpp_jp" placeholder="2" min="1" max="10">
                    </div>
                    <div class="form-group half">
                        <label>Durasi per JP (Menit)</label>
                        <select id="rpp_durasi_jp">
                            <option value="35">35 Menit (SD)</option>
                            <option value="40">40 Menit (SMP)</option>
                            <option value="45" selected>45 Menit (SMA/SMK)</option>
                            <option value="60">60 Menit</option>
                        </select>
                    </div>
                </div>

                <button type="button" onclick="generateRPP()" class="btn-submit">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Buat Modul Ajar (10 Koin)
                </button>
            </form>

            <form id="form-quiz" class="hidden-form">
                <p class="section-label">Konfigurasi Soal</p>
                
                <div class="form-row">
                    <div class="form-group half">
                        <label>Jenjang</label>
                        <select id="quiz_jenjang" onchange="updateKelas('quiz')">
                            <option value="" disabled selected>Pilih Jenjang...</option>
                            <option value="SD">SD</option>
                            <option value="SMP">SMP</option>
                            <option value="SMA">SMA</option>
                        </select>
                    </div>
                    <div class="form-group half">
                        <label>Kelas</label>
                        <select id="quiz_kelas"><option disabled selected>-</option></select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Mata Pelajaran</label>
                    <select id="quiz_mapel" onchange="checkMapelLainnya('quiz')">
                        <option disabled selected>Pilih Jenjang & Kelas dulu...</option>
                    </select>
                    <input type="text" id="quiz_mapel_manual" class="hidden" placeholder="Tulis mapel..." style="margin-top: 10px;">
                </div>

                <div class="form-group">
                    <label>Topik Soal</label>
                    <input type="text" id="quiz_topik" placeholder="Cth: Pecahan Desimal" min="5" max="50">
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label>Jumlah Soal</label>
                        <input type="number" id="quiz_jumlah" value="5" min="1" max="20" oninput="if(value > 20) value=20; if(value < 1) value=1;">
                    </div>
                    <div class="form-group half">
                        <label>Jenis Soal</label>
                        <select id="quiz_jenis">
                            <option value="Pilihan Ganda">Pilihan Ganda</option>
                            <option value="Essay">Essay / Uraian</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Tingkat Kesulitan</label>
                    <select id="quiz_kesulitan">
                        <option value="Mudah">Mudah (LOTS)</option>
                        <option value="Sedang">Sedang (MOTS)</option>
                        <option value="Sulit">Sulit (HOTS)</option>
                    </select>
                </div>

                <button type="button" onclick="generateQuiz()" class="btn-submit">
                    <i class="fa-solid fa-puzzle-piece"></i> Buat Soal (10 Koin)
                </button>
            </form>

            
            <form id="form-rapor" class="hidden-form">
                <p class="section-label">Generator Narasi Rapor</p>

                <div class="form-group">
                    <label>Nama Siswa</label>
                    <input type="text" id="rapor_nama" placeholder="Cth: Budi Santoso">
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label>Kelas</label>
                        <input type="text" id="rapor_kelas" placeholder="X-A">
                    </div>
                    <div class="form-group half">
                        <label>Nilai Rata-rata</label>
                        <input type="text" id="rapor_nilai" placeholder="85,5" inputmode="decimal">
                    </div>
                </div>

                <div class="form-group">
                    <label>Sikap / Karakter Utama</label>
                    <select id="rapor_sikap">
                        <option value="Sangat Rajin & Aktif">Sangat Rajin & Aktif</option>
                        <option value="Sopan namun Pendiam">Sopan namun Pendiam</option>
                        <option value="Perlu Bimbingan Fokus">Perlu Bimbingan Fokus</option>
                        <option value="Sering Terlambat">Sering Terlambat</option>
                        <option value="Memiliki Jiwa Kepemimpinan">Memiliki Jiwa Kepemimpinan</option>
                        <option value="Lainnya">Lainnya (Tulis di catatan)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Catatan Khusus (Opsional)</label>
                    <textarea id="rapor_catatan" rows="2" placeholder="Cth: Sering tidak mengerjakan PR, tapi jago olahraga..."></textarea>
                </div>

                <button type="button" onclick="generateRapor()" class="btn-submit">
                    <i class="fa-solid fa-feather"></i> Buat Narasi (30 Koin)
                </button>
            </form>
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #334155; text-align: center;">
                <p style="font-size: 0.75rem; color: #94a3b8;">
                    Powered by 
                    <span style="font-weight: 600; background: linear-gradient(to right, #2D79EF, #EC5360); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        Google Gemini </i>
                    </span>
                </p>
            </div>
        </aside>

        <main class="result-panel">
            <div id="loading-overlay" class="hidden">
                <div class="spinner"></div>
                <p style="color: var(--text-muted);">Sedang berpikir...</p>
            </div>

            <div id="welcome-screen" class="relative flex flex-col items-center justify-center h-full text-center p-6 animate-fade-in">
    
                <div class="absolute top-6 right-6 z-10">
                    <button onclick="openHistoryMode()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white px-4 py-2 rounded-lg border border-slate-700 transition text-sm font-medium flex items-center gap-2 shadow-lg">
                        <i class="fa-solid fa-clock-rotate-left text-blue-500"></i>
                        <span>Buka Riwayat</span>
                    </button>
                </div>

                <div class="flex flex-col items-center max-w-lg mx-auto mt-[-40px]"> <div class="bg-slate-800/50 p-6 rounded-full w-24 h-24 flex items-center justify-center mb-6 shadow-xl border border-slate-700 relative">
                        <div class="absolute inset-0 bg-blue-500/10 rounded-full blur-xl"></div> <i class="fa-solid fa-robot text-4xl text-blue-500 animate-bounce"></i>
                    </div>

                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-3 tracking-tight">
                        Halo, Pengajar Hebat!
                    </h2>
                    <p class="text-gray-400 text-m leading-relaxed">
                        Pilih fitur di panel kiri untuk mulai membuat konten pembelajaran instan.
                    </p>
                </div>

            </div>

            <div id="result-content" class="hidden h-full flex flex-col relative">
    
                <div class="flex justify-between items-center mb-6 relative z-20">
                    <h2 id="result-title" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                        Hasil Generate
                    </h2>
                    
                    <div class="relative">
                        <button onclick="toggleHistoryDropdown()" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 px-4 py-2 rounded-lg transition text-sm font-medium">
                            <i class="fa-solid fa-clock-rotate-left text-blue-400"></i>
                            <span class="hidden md:inline">Riwayat</span>
                            <i class="fa-solid fa-chevron-down text-xs ml-1 transition" id="history-arrow"></i>
                        </button>

                        <div id="history-dropdown" class="hidden absolute right-0 top-full mt-2 w-80 bg-slate-900 border border-slate-700 rounded-xl shadow-2xl overflow-hidden z-50 transform origin-top-right transition-all">
                            <div class="p-3 border-b border-slate-800 bg-slate-800/50 flex justify-between items-center">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Terakhir Disimpan</span>
                                <button onclick="toggleHistoryDropdown()" class="text-slate-500 hover:text-white">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>

                            <div id="history-list-dropdown" class="max-h-64 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                <p class="text-xs text-center py-4 text-gray-500">Memuat...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800/50 p-6 rounded-2xl border border-slate-700 flex-1 overflow-y-auto custom-scrollbar shadow-inner relative">
                    
                    <div class="absolute top-4 right-4 flex items-center gap-2 z-10">
                        <button onclick="copyToClipboard()" class="bg-slate-700/50 hover:bg-slate-600 text-slate-300 hover:text-white px-3 py-2 rounded-lg transition border border-slate-600 flex items-center gap-2 text-xs font-medium" title="Salin Teks">
                            <i class="fa-regular fa-copy"></i>
                            <span class="hidden sm:inline">Salin</span>
                        </button>

                        <div class="relative">
                            <button onclick="toggleExportDropdown()" id="btn-export-trigger" class="bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white px-3 py-2 rounded-lg transition border border-blue-500/30 flex items-center gap-2 text-xs font-medium">
                                <i class="fa-solid fa-download"></i>
                                <span>Download</span>
                                <i class="fa-solid fa-chevron-down text-[10px] ml-1 transition" id="export-arrow"></i>
                            </button>

                            <div id="export-dropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-slate-800 border border-slate-700 rounded-xl shadow-xl z-50 overflow-hidden origin-top-right">
                                <div class="px-4 py-2 bg-slate-900/50 border-b border-slate-700 text-[10px] font-bold text-gray-400 uppercase tracking-wider">
                                    Pilih Format
                                </div>
                                <button onclick="exportToWord(); toggleExportDropdown()" class="w-full text-left px-4 py-3 text-slate-300 hover:text-white hover:bg-slate-700 flex items-center gap-3 transition group">
                                    <div class="w-6 h-6 rounded bg-blue-900/50 text-blue-400 flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition">
                                        <i class="fa-solid fa-file-word"></i>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium">Microsoft Word</span>
                                        <span class="text-[10px] text-slate-500 group-hover:text-slate-400">.docx Document</span>
                                    </div>
                                </button>
                                <button onclick="exportToPDF(); toggleExportDropdown()" class="w-full text-left px-4 py-3 text-slate-300 hover:text-white hover:bg-slate-700 flex items-center gap-3 transition group border-t border-slate-700/50">
                                    <div class="w-6 h-6 rounded bg-red-900/50 text-red-400 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition">
                                        <i class="fa-solid fa-file-pdf"></i>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-sm font-medium">PDF Document</span>
                                        <span class="text-[10px] text-slate-500 group-hover:text-slate-400">Siap Cetak</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="markdown-output" class="prose prose-invert max-w-none text-gray-300 text-sm leading-relaxed"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="export.js"></script>
    <script src="script.js"></script>
    
</body>
</html>